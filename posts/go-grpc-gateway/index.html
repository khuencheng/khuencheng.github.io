<!doctype html><html lang=zh><head><title>通过 gRPC-Gateway 开发 RESTful API :: Jack Cheng 的个人博客</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="gRPC-Gateway 简介 gRPC-Gateway 是 protoc 的一个插件，工作机制是读取一个 gRPC 服务定义并生成一个反向代理服务器，将 RESTful JSON API 翻译成 gRPC。 这个服务器是根据编写的 gRPC 定义中的自定义选项来生成的。 安装使用 依赖工具 工具 简介 安装 protobuf protocol buffer 编译所需的命"><meta name=keywords content="[Hugo Programming]"><meta name=robots content="noodp"><link rel=canonical href=https://khuencheng.github.io/posts/go-grpc-gateway/><link rel=stylesheet href=https://khuencheng.github.io/assets/style.css><link rel=stylesheet href=assets/%25!s%28%3cnil%3e%29.css><link rel=apple-touch-icon href=https://khuencheng.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://khuencheng.github.io/img/favicon/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="og:title" content="通过 gRPC-Gateway 开发 RESTful API"><meta property="og:description" content="gRPC-Gateway 简介 gRPC-Gateway 是 protoc 的一个插件，工作机制是读取一个 gRPC 服务定义并生成一个反向代理服务器，将 RESTful JSON API 翻译成 gRPC。 这个服务器是根据编写的 gRPC 定义中的自定义选项来生成的。 安装使用 依赖工具 工具 简介 安装 protobuf protocol buffer 编译所需的命"><meta property="og:url" content="https://khuencheng.github.io/posts/go-grpc-gateway/"><meta property="og:site_name" content="Jack Cheng 的个人博客"><meta property="og:image" content="img/favicon/%!s().png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="编程"><meta property="article:published_time" content="2022-03-13 18:13:14 +0800 +0800"></head><body><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://khuencheng.github.io/><div class=logo>Terminal</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/categories/>Categories</a></li><li><a href=/about/>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/categories/>Categories</a></li><li><a href=/about/>About</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://khuencheng.github.io/posts/go-grpc-gateway/>通过 gRPC-Gateway 开发 RESTful API</a></h1><div class=post-meta><span class=post-date>2022-03-13</span></div><span class=post-tags>#<a href=https://khuencheng.github.io/tags/golang/>Golang</a>&nbsp;
#<a href=https://khuencheng.github.io/tags/web/>Web</a>&nbsp;
#<a href=https://khuencheng.github.io/tags/grpc/>gRPC</a>&nbsp;
#<a href=https://khuencheng.github.io/tags/grpc-gateway/>gRPC-gateway</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#grpc-gateway-简介>gRPC-Gateway 简介</a></li><li><a href=#安装使用>安装使用</a><ul><li><a href=#依赖工具>依赖工具</a></li><li><a href=#步骤>步骤</a></li></ul></li><li><a href=#原理>原理</a><ul><li><a href=#源码分析>源码分析</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div><div class=post-content><div><h2 id=grpc-gateway-简介>gRPC-Gateway 简介<a href=#grpc-gateway-简介 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>gRPC-Gateway 是 protoc 的一个插件，工作机制是读取一个 gRPC 服务定义并生成一个反向代理服务器，将 RESTful JSON API 翻译成 gRPC。</p><p>这个服务器是根据编写的 gRPC 定义中的自定义选项来生成的。
<img src=https://grpc-ecosystem.github.io/grpc-gateway/assets/images/architecture_introduction_diagram.svg alt></p><h2 id=安装使用>安装使用<a href=#安装使用 class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=依赖工具>依赖工具<a href=#依赖工具 class=hanchor arialabel=Anchor>&#8983;</a></h3><table><thead><tr><th style=text-align:left>工具</th><th style=text-align:left>简介</th><th style=text-align:left>安装</th></tr></thead><tbody><tr><td style=text-align:left>protobuf</td><td style=text-align:left>protocol buffer 编译所需的命令行</td><td style=text-align:left><a href=http://google.github.io/proto-lens/installing-protoc.html>http://google.github.io/proto-lens/installing-protoc.html</a></td></tr><tr><td style=text-align:left>protoc-gen-go</td><td style=text-align:left>从 proto 文件，生成 .go 文件</td><td style=text-align:left><a href=https://grpc.io/docs/languages/go/quickstart/>https://grpc.io/docs/languages/go/quickstart/</a></td></tr><tr><td style=text-align:left>protoc-gen-go-grpc</td><td style=text-align:left>从 proto 文件，生成 gRPC 相关的 .go 文件</td><td style=text-align:left><a href=https://grpc.io/docs/languages/go/quickstart/>https://grpc.io/docs/languages/go/quickstart/</a></td></tr><tr><td style=text-align:left>protoc-gen-grpc-gateway</td><td style=text-align:left>从 proto 文件，生成 gRPC-gateway 相关的 .go 文件</td><td style=text-align:left><a href=https://github.com/grpc-ecosystem/grpc-gateway#installation>https://github.com/grpc-ecosystem/grpc-gateway#installation</a></td></tr><tr><td style=text-align:left>protoc-gen-openapiv2</td><td style=text-align:left>从 proto 文件，生成 swagger 文档所需的参数文件</td><td style=text-align:left><a href=https://github.com/grpc-ecosystem/grpc-gateway#installation>https://github.com/grpc-ecosystem/grpc-gateway#installation</a></td></tr><tr><td style=text-align:left>buf</td><td style=text-align:left>protobuf 管理工具，可选，简化命令行操作和protobuf 文件管理</td><td style=text-align:left><a href=https://docs.buf.build/installation>https://docs.buf.build/installation</a></td></tr></tbody></table><h3 id=步骤>步骤<a href=#步骤 class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=编写buf配置>编写buf配置<a href=#编写buf配置 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>buf.gen.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>out</span><span class=p>:</span><span class=w> </span><span class=l>internal/proto</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>paths=source_relative</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>go-grpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>out</span><span class=p>:</span><span class=w> </span><span class=l>internal/proto</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>paths=source_relative</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>require_unimplemented_servers=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grpc-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>out</span><span class=p>:</span><span class=w> </span><span class=l>internal/proto</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>paths=source_relative</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>openapiv2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>out</span><span class=p>:</span><span class=w> </span><span class=l>openapi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>json_names_for_fields=false</span><span class=w>
</span></span></span></code></pre></div><p>buf.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>buf.build/myworkspace/grpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>deps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>buf.build/beta/googleapis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>buf.build/grpc-ecosystem/grpc-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roots</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>proto</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>lint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DEFAULT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rpc_allow_google_protobuf_empty_requests</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rpc_allow_google_protobuf_empty_responses</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>breaking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>FILE</span><span class=w>
</span></span></span></code></pre></div><h4 id=编写proto>编写proto<a href=#编写proto class=hanchor arialabel=Anchor>&#8983;</a></h4><p>和 gRPC 接口 proto 文件不一样的是，其中包含了对 HTTP 的注释。</p><ul><li>通过 gRPC options 添加 HTTP API 信息，比如 HTTP method、path、body、额外绑定等，需引用 <a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>google/api/annotations.proto</a></li><li>通过 protobuf message field，添加额外信息，来实现 HTTP 请求参数和响应 body 的约束，并且可以生成 swagger 文档，需引用 <a href=https://github.com/grpc-ecosystem/grpc-gateway/blob/master/protoc-gen-openapiv2/options/annotations.proto>protoc-gen-openapiv2/options/annotations.proto</a></li></ul><p>demo.proto</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>console</span><span class=o>.</span><span class=n>v1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;git.yourcompany.com/yourgroup/grpc-gateway-demo/proto/console/v1&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/protobuf/empty.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/api/annotations.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;protoc-gen-openapiv2/options/annotations.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// DemoService is the demo service definition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>service</span> <span class=n>DemoService</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Hello</span><span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloResponse</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>get</span><span class=o>:</span> <span class=s>&#34;/web/v1/hello-messages/{name}&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>additional_bindings</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>                <span class=n>get</span><span class=o>:</span> <span class=s>&#34;/client/v1/hello-messages/{name}&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span> <span class=p>[(</span><span class=n>grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>description</span><span class=o>:</span> <span class=s>&#34;名称&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=k>required</span><span class=o>:</span> <span class=p>[</span><span class=s>&#39;name&#39;</span><span class=p>],</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>type</span><span class=o>:</span> <span class=n>STRING</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>HelloResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span> <span class=p>[(</span><span class=n>grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>description</span><span class=o>:</span> <span class=s>&#34;响应消息&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=k>required</span><span class=o>:</span> <span class=p>[</span><span class=s>&#39;message&#39;</span><span class=p>],</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>type</span><span class=o>:</span> <span class=n>STRING</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><h4 id=生成代码>生成代码<a href=#生成代码 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>命令</p><p>grpc.sh</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>buf lint
</span></span><span class=line><span class=cl>buf breaking --against .git<span class=sb>``</span><span class=c1>#branch=master</span>
</span></span><span class=line><span class=cl>buf generate
</span></span></code></pre></div><p>目录结构</p><p>demo.pb.gw.go 为 gRPC-gateway 生成的文件，处理 HTTP RESTful 到 gRPC 的请求。</p><p>grpc-gateway-demo/internal/proto</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qtmf-demo<span class=sb>``</span>/internal/proto
</span></span><span class=line><span class=cl>➜ tree
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>└── console
</span></span><span class=line><span class=cl>  <span class=sb>``</span>└── v1
</span></span><span class=line><span class=cl>    <span class=sb>``</span>├── demo.pb.go
</span></span><span class=line><span class=cl>    <span class=sb>``</span>├── demo.pb.gw.go
</span></span><span class=line><span class=cl>    <span class=sb>``</span>└── demo_grpc.pb.go
</span></span></code></pre></div><p>生成的 swagger 文档</p><p><strong>[DemoService]</strong></p><p><strong>GET</strong> /web/v1/hello-messages/{name}</p><p><strong>GET</strong> /client/v1/hello-messages/{name}</p><h4 id=编写-go-rpc-service>编写 go rpc service<a href=#编写-go-rpc-service class=hanchor arialabel=Anchor>&#8983;</a></h4><p>grpc/main.go</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DemoHandler</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Hello 编写实现方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>DemoHandler</span><span class=p>)</span> <span class=nf>Hello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>consoleV1</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>consoleV1</span><span class=p>.</span><span class=nx>HelloResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>``</span><span class=k>return</span><span class=s>` `</span><span class=o>&amp;</span><span class=nx>consoleV1</span><span class=p>.</span><span class=nx>HelloResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>``</span><span class=nx>Message</span><span class=p>:</span> <span class=s>``&#34;hello: &#34;` `</span><span class=o>+</span> <span class=nx>request</span><span class=p>.</span><span class=nf>GetName</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=s>``</span><span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterDemoServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Register reflection service on gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>reflection</span><span class=p>.</span><span class=nf>Register</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>启动服务</p><p>main.go</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=s>&#34;github.com/golang/glog&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;github.com/grpc-ecosystem/grpc-gateway/v2/runtime&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;google.golang.org/grpc/credentials/insecure&#34;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=nx>gw</span> <span class=s>&#34;github.com/yourorg/yourrepo/proto/gen/go/your/service/v1/your_service&#34;</span>  <span class=c1>// Update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// command-line options:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// gRPC server endpoint
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>grpcServerEndpoint</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;grpc-server-endpoint&#34;</span><span class=p>,</span>  <span class=s>&#34;localhost:9090&#34;</span><span class=p>,</span> <span class=s>&#34;gRPC server endpoint&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>run</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=c1>// Register gRPC server endpoint
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Note: Make sure the gRPC server is running properly and accessible
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>mux</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>opts</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>DialOption</span><span class=p>{</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>WithTransportCredentials</span><span class=p>(</span><span class=nx>insecure</span><span class=p>.</span><span class=nf>NewCredentials</span><span class=p>())}</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gw</span><span class=p>.</span><span class=nf>RegisterYourServiceHandlerFromEndpoint</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>mux</span><span class=p>,</span>  <span class=o>*</span><span class=nx>grpcServerEndpoint</span><span class=p>,</span> <span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=c1>// Start HTTP server (and proxy calls to gRPC server endpoint)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8081&#34;</span><span class=p>,</span> <span class=nx>mux</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>glog</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>run</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>glog</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=原理>原理<a href=#原理 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>回到官方示意图，清晰的画出了从 proto 文件，生成 gRPC Service 和 反向代理的过程。</p><p><img src=https://grpc-ecosystem.github.io/grpc-gateway/assets/images/architecture_introduction_diagram.svg alt></p><h3 id=源码分析>源码分析<a href=#源码分析 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>gRPC-gateway 主要分代码生成、生成的反向代理以及 HTTP 和 gRPC 协议处理的 runtime 等几大部分。</p><h4 id=代码生成>代码生成<a href=#代码生成 class=hanchor arialabel=Anchor>&#8983;</a></h4><p><a href=https://github.com/grpc-ecosystem/grpc-gateway/blob/master/protoc-gen-grpc-gateway/main.go#L65>https://github.com/grpc-ecosystem/grpc-gateway/blob/master/protoc-gen-grpc-gateway/main.go#L65</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>glog</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>*</span><span class=nx>versionFlag</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Version %v, commit %v, built at %v\n&#34;</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>commit</span><span class=p>,</span> <span class=nx>date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nx>protogen</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ParamFunc</span><span class=p>:</span> <span class=nx>flag</span><span class=p>.</span><span class=nx>CommandLine</span><span class=p>.</span><span class=nx>Set</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}.</span><span class=nf>Run</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>gen</span> <span class=o>*</span><span class=nx>protogen</span><span class=p>.</span><span class=nx>Plugin</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>reg</span> <span class=o>:=</span> <span class=nx>descriptor</span><span class=p>.</span><span class=nf>NewRegistry</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nf>applyFlags</span><span class=p>(</span><span class=nx>reg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>codegenerator</span><span class=p>.</span><span class=nf>SetSupportedFeaturesOnPluginGen</span><span class=p>(</span><span class=nx>gen</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>generator</span> <span class=o>:=</span> <span class=nx>gengateway</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>reg</span><span class=p>,</span> <span class=o>*</span><span class=nx>useRequestContext</span><span class=p>,</span> <span class=o>*</span><span class=nx>registerFuncSuffix</span><span class=p>,</span> <span class=o>*</span><span class=nx>allowPatchFeature</span><span class=p>,</span> <span class=o>*</span><span class=nx>standalone</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>glog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Parsing code generator request&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>reg</span><span class=p>.</span><span class=nf>LoadFromPlugin</span><span class=p>(</span><span class=nx>gen</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>unboundHTTPRules</span> <span class=o>:=</span> <span class=nx>reg</span><span class=p>.</span><span class=nf>UnboundExternalHTTPRules</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>unboundHTTPRules</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;HTTP rules without a matching selector: %s&#34;</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>unboundHTTPRules</span><span class=p>,</span> <span class=s>&#34;, &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>targets</span> <span class=p>[]</span><span class=o>*</span><span class=nx>descriptor</span><span class=p>.</span><span class=nx>File</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>target</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>gen</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>FileToGenerate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>reg</span><span class=p>.</span><span class=nf>LookupFile</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>targets</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>targets</span><span class=p>,</span> <span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>files</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>generator</span><span class=p>.</span><span class=nf>Generate</span><span class=p>(</span><span class=nx>targets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>files</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>glog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;NewGeneratedFile %q in %s&#34;</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nf>GetName</span><span class=p>(),</span> <span class=nx>f</span><span class=p>.</span><span class=nx>GoPkg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>genFile</span> <span class=o>:=</span> <span class=nx>gen</span><span class=p>.</span><span class=nf>NewGeneratedFile</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nf>GetName</span><span class=p>(),</span> <span class=nx>protogen</span><span class=p>.</span><span class=nf>GoImportPath</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>GoPkg</span><span class=p>.</span><span class=nx>Path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>genFile</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nf>GetContent</span><span class=p>()));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nx>glog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Processed code generator request&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=生成的反向代理>生成的反向代理<a href=#生成的反向代理 class=hanchor arialabel=Anchor>&#8983;</a></h4><p><a href=https://github.com/grpc-ecosystem/grpc-gateway/blob/master/examples/internal/helloworld/helloworld.pb.gw.go#L738>https://github.com/grpc-ecosystem/grpc-gateway/blob/master/examples/internal/helloworld/helloworld.pb.gw.go#L738</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 处理 HTTP 请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>RegisterGreeterHandlerServer</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>mux</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>ServeMux</span><span class=p>,</span> <span class=nx>server</span> <span class=nx>GreeterServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;GET&#34;</span><span class=p>,</span> <span class=nx>pattern_Greeter_SayHello_0</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>pathParams</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>stream</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>ServerTransportStream</span>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewContextWithServerTransportStream</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>inboundMarshaler</span><span class=p>,</span> <span class=nx>outboundMarshaler</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>MarshalerForRequest</span><span class=p>(</span><span class=nx>mux</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>rctx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>AnnotateIncomingContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>mux</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=s>&#34;/grpc.gateway.examples.internal.helloworld.Greeter/SayHello&#34;</span><span class=p>,</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>WithHTTPPathPattern</span><span class=p>(</span><span class=s>&#34;/say/{name}&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>runtime</span><span class=p>.</span><span class=nf>HTTPError</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>mux</span><span class=p>,</span> <span class=nx>outboundMarshaler</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>resp</span><span class=p>,</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>local_request_Greeter_SayHello_0</span><span class=p>(</span><span class=nx>rctx</span><span class=p>,</span> <span class=nx>inboundMarshaler</span><span class=p>,</span> <span class=nx>server</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>pathParams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>md</span><span class=p>.</span><span class=nx>HeaderMD</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>TrailerMD</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>md</span><span class=p>.</span><span class=nx>HeaderMD</span><span class=p>,</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Header</span><span class=p>()),</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>md</span><span class=p>.</span><span class=nx>TrailerMD</span><span class=p>,</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Trailer</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NewServerMetadataContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>runtime</span><span class=p>.</span><span class=nf>HTTPError</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>mux</span><span class=p>,</span> <span class=nx>outboundMarshaler</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=nf>forward_Greeter_SayHello_0</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>mux</span><span class=p>,</span> <span class=nx>outboundMarshaler</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>resp</span><span class=p>,</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>GetForwardResponseOptions</span><span class=p>()</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// 请求 gRPC Client
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>request_Greeter_SayHello_0</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>marshaler</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Marshaler</span><span class=p>,</span> <span class=nx>client</span> <span class=nx>GreeterClient</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>pathParams</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>proto</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>ServerMetadata</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>protoReq</span> <span class=nx>HelloRequest</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>metadata</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>ServerMetadata</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>val</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=nx>ok</span>  <span class=kt>bool</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>        <span class=nx>_</span>   <span class=p>=</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nx>val</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>pathParams</span><span class=p>[</span><span class=s>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>InvalidArgument</span><span class=p>,</span> <span class=s>&#34;missing parameter %s&#34;</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nx>protoReq</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>InvalidArgument</span><span class=p>,</span> <span class=s>&#34;type mismatch, parameter: %s, error: %v&#34;</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>ParseForm</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>InvalidArgument</span><span class=p>,</span> <span class=s>&#34;%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>PopulateQueryParameters</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>protoReq</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Form</span><span class=p>,</span> <span class=nx>filter_Greeter_SayHello_0</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>InvalidArgument</span><span class=p>,</span> <span class=s>&#34;%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nx>msg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>protoReq</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Header</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>HeaderMD</span><span class=p>),</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Trailer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>TrailerMD</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>,</span> <span class=nx>err</span>
</span></span></code></pre></div><h4 id=错误映射>错误映射<a href=#错误映射 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>从 gRPC status code 转换到 HTTP status code</p><p><a href=https://github.com/grpc-ecosystem/grpc-gateway/blob/master/runtime/errors.go>https://github.com/grpc-ecosystem/grpc-gateway/blob/master/runtime/errors.go</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// HTTPStatusFromCode converts a gRPC error code into the corresponding HTTP response status.
</span></span></span><span class=line><span class=cl><span class=c1>// See: https://github.com/googleapis/googleapis/blob/master/google/rpc/code.proto
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>HTTPStatusFromCode</span><span class=p>(</span><span class=nx>code</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Code</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>code</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>OK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Canceled</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusRequestTimeout</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Unknown</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>InvalidArgument</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>DeadlineExceeded</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusGatewayTimeout</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>NotFound</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusNotFound</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>AlreadyExists</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusConflict</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>PermissionDenied</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Unauthenticated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>ResourceExhausted</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusTooManyRequests</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>FailedPrecondition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Note, this deliberately doesn&#39;t translate to the similarly named &#39;412 Precondition Failed&#39; HTTP response status.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Aborted</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusConflict</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>OutOfRange</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Unimplemented</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusNotImplemented</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Internal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>Unavailable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusServiceUnavailable</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>DataLoss</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nx>grpclog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Unknown gRPC error code: %v&#34;</span><span class=p>,</span> <span class=nx>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=参考>参考<a href=#参考 class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://github.com/grpc-ecosystem/grpc-gateway#readme>https://github.com/grpc-ecosystem/grpc-gateway#readme</a></p><p><a href=https://grpc-ecosystem.github.io/grpc-gateway/>https://grpc-ecosystem.github.io/grpc-gateway/</a></p><p><a href=https://github.com/grpc/grpc-go>https://github.com/grpc/grpc-go</a></p><p><a href=https://grpc.io/docs/>https://grpc.io/docs/</a></p><p><a href=https://github.com/googleapis/googleapis/tree/master/google/api>https://github.com/googleapis/googleapis/tree/master/google/api</a></p><p><a href=https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-openapiv2/options>https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-openapiv2/options</a></p></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://khuencheng.github.io/assets/main.js></script>
<script src=https://khuencheng.github.io/assets/prism.js></script></div></body></html>